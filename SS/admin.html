<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>HOMEY — لوحة الطلبات</title>
  <style>
    :root{
      --ink:#0f172a; --ink-2:#64748b; --green:#06b6d4; --danger:#ef4444; --ok:#22c55e;
      --glass:255 255 255/.65; --glass-b:255 255 255/.32; --radius:16px;
    }
    @media (prefers-color-scheme:dark){
      :root{ --ink:#e6f4ee; --ink-2:#b4c8bf; --glass:10 20 26/.35; --glass-b:255 255 255/.15; }
      body{ background: radial-gradient(1200px 600px at 80% -10%, #0b2f24, transparent),
                         radial-gradient(900px 500px at 10% 110%, #07362a, transparent) }
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: system-ui, "Noto Kufi Arabic", sans-serif; color:var(--ink); background:linear-gradient(135deg,#cffafe,#a5f3fc 45%,#e0f2fe); min-height:100vh}
    .wrap{max-width:1100px; margin:auto; padding:16px}
    .glass{background: color-mix(in oklab, rgb(var(--glass)) 92%, transparent);
           border:1px solid rgb(var(--glass-b)); border-radius:16px; box-shadow:0 10px 30px rgba(6,182,212,.18); backdrop-filter: blur(12px) saturate(120%)}
    h1{margin:0}
    header{display:flex; gap:8px; align-items:center; justify-content:space-between}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .btn{background:var(--green); color:#062014; border:none; border-radius:12px; padding:.55rem .8rem; font-weight:800; cursor:pointer}
    .btn-ghost{background:color-mix(in oklab, rgb(var(--glass)) 90%, transparent); border:1px solid rgb(var(--glass-b)); border-radius:12px; padding:.5rem .8rem; cursor:pointer}
    .btn[disabled], .btn-ghost[disabled]{opacity:.5; cursor:not-allowed}
    .chip{display:inline-block; padding:.25rem .5rem; border-radius:999px; border:1px solid rgb(var(--glass-b)); background:color-mix(in oklab, rgb(var(--glass)) 88%, transparent)}
    .danger{background:var(--danger); color:#031014}
    .ok{background:var(--ok); color:#031014}
    .toolbar{margin-top:12px; padding:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .toolbar input, .toolbar select{all:unset; background:color-mix(in oklab, rgb(var(--glass)) 90%, transparent); border:1px solid rgb(var(--glass-b)); border-radius:12px; padding:.5rem .7rem}
    .list{display:grid; gap:10px; margin-top:12px}
    .card{padding:12px}
    .row{display:flex; justify-content:space-between; align-items:center; gap:8px}
    .muted{color:var(--ink-2)}
    #toast{position:fixed; inset-inline:12px; inset-block-end:24px; padding:10px 14px; display:none; font-weight:700}
    #toast.show{display:block}
    /* login box */
    .login{max-width:420px; margin:40px auto; padding:16px; display:grid; gap:10px}
    .login input{all:unset; background:color-mix(in oklab, rgb(var(--glass)) 90%, transparent); border:1px solid rgb(var(--glass-b)); border-radius:12px; padding:.6rem .7rem}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>لوحة الطلبات</h1>
      <div class="actions">
        <button id="btn-refresh" class="btn-ghost">تحديث</button>
        <button id="btn-export-orders" class="btn-ghost">تصدير orders.csv</button>
        <button id="btn-export-items" class="btn-ghost">تصدير order_items.csv</button>
        <button id="btn-signout" class="btn-ghost">تسجيل الخروج</button>
      </div>
    </header>

    <!-- أدوات فلترة -->
    <div class="glass toolbar">
      <label>الحالة
        <select id="filter-status">
          <option value="all">الكل</option>
          <option value="pending">قيد الانتظار</option>
          <option value="confirmed">مؤكد</option>
          <option value="canceled">ملغي</option>
        </select>
      </label>
      <input id="search" placeholder="بحث: رقم الطلب/المستخدم/المنتج…" style="min-width:260px">
      <span id="status" class="chip">—</span>
    </div>

    <!-- صندوق تسجيل الدخول (يظهر لغير المصدقين) -->
    <form id="login" class="glass login" style="display:none">
      <strong>تسجيل الدخول (أدمن)</strong>
      <input id="email" type="email" placeholder="البريد الإلكتروني" required>
      <input id="pass" type="password" placeholder="كلمة المرور (6+)" minlength="6" required>
      <button class="btn" type="submit">دخول</button>
      <div class="muted">سننشئ حسابًا تلقائيًا إذا لم يكن موجودًا.</div>
    </form>

    <!-- قائمة الطلبات -->
    <div id="list" class="list"></div>
  </div>

  <div id="toast" class="glass" role="status" aria-live="polite">—</div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ===== Supabase config (مشروعك) =====
    const SB_URL  = "https://wlnaasqzejdtxjghutvd.supabase.co";
    const SB_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsbmFhc3F6ZWpkdHhqZ2h1dHZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTkyMjcsImV4cCI6MjA3MDczNTIyN30.HbTAM182uyGQ8we1GcG2feRSMrM-5l-4ihcYTy0t5Qc";
    const sb = supabase.createClient(SB_URL, SB_ANON);

    // ===== Helpers =====
    const $ = s => document.querySelector(s);
    const SAR = new Intl.NumberFormat('ar-SA',{style:'currency', currency:'SAR'});
    function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(toast._t); toast._t=setTimeout(()=>t.classList.remove('show'),1600); }

    // ===== State =====
    const state = { user:null, isAdmin:false, orders:[], items:[], filter:'all', q:'' };

    // ===== Auth / Admin gate =====
    async function ensureAuth(){
      const { data:{ user } } = await sb.auth.getUser();
      state.user = user || null;
      if(!user){
        $('#status').textContent = 'سجّل الدخول أولًا';
        $('#login').style.display = 'grid';
        return false;
      }
      // ensure profile exists and check admin
      await sb.from('profiles').upsert({ id:user.id, email:user.email }).select();
      const { data:prof } = await sb.from('profiles').select('is_admin').eq('id', user.id).single();
      if(!prof?.is_admin){
        $('#status').textContent = 'ممنوع: لست أدمن';
        $('#login').style.display = 'grid';
        return false;
      }
      state.isAdmin = true;
      $('#login').style.display = 'none';
      $('#status').textContent = 'مرحبًا أدمن 👋';
      return true;
    }

    // Login form
    $('#login').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = $('#email').value.trim();
      const password = $('#pass').value.trim();
      if(!email || password.length<6) return toast('تحقق من المدخلات');
      let out = await sb.auth.signInWithPassword({ email, password });
      if(out.error){ // جرّب إنشاء ثم دخول
        const up = await sb.auth.signUp({ email, password });
        if(up.error){ toast('فشل الدخول: ' + (up.error.message||'')); return; }
        out = await sb.auth.signInWithPassword({ email, password });
        if(out.error){ toast('فشل الدخول: ' + (out.error.message||'')); return; }
      }
      if(await ensureAuth()) load();
    });

    $('#btn-signout').addEventListener('click', async ()=>{
      await sb.auth.signOut(); state.user=null; state.isAdmin=false;
      $('#list').innerHTML=''; $('#status').textContent='تم تسجيل الخروج';
      $('#login').style.display='grid';
    });

    // ===== Load orders + items =====
    async function load(){
      if(!(await ensureAuth())) return;
      // build query with status
      const st = $('#filter-status').value;
      let q = sb.from('orders').select('id,user_id,total,discount,status,created_at').order('created_at',{ascending:false});
      if(st!=='all') q = q.eq('status', st);
      const { data: orders, error } = await q;
      if(error){ console.error(error); toast('خطأ في جلب الطلبات'); return; }
      state.orders = orders || [];

      // fetch items for all orders in batch
      if(state.orders.length){
        const ids = state.orders.map(o=>o.id);
        const { data: items } = await sb.from('order_items')
          .select('order_id,product_name,price,qty')
          .in('order_id', ids);
        state.items = items || [];
      } else {
        state.items = [];
      }

      render();
    }

    function render(){
      const root = $('#list'); root.innerHTML='';
      const q = ($('#search').value||'').trim().toLowerCase();
      const filtered = state.orders.filter(o=>{
        if(!q) return true;
        const id = String(o.id).toLowerCase();
        const uid = String(o.user_id).toLowerCase();
        const items = state.items.filter(it=>it.order_id===o.id).map(it=>it.product_name.toLowerCase()).join(' ');
        return id.includes(q) || uid.includes(q) || items.includes(q);
      });

      if(!filtered.length){ root.innerHTML = `<div class="glass card muted">لا توجد طلبات</div>`; return; }

      const map = new Map();
      state.items.forEach(it=>{
        if(!map.has(it.order_id)) map.set(it.order_id, []);
        map.get(it.order_id).push(it);
      });

      for(const o of filtered){
        const items = map.get(o.id) || [];
        const total = (o.total||0) - (o.discount||0);
        const card = document.createElement('div');
        card.className = 'glass card';
        const canConfirm = o.status!=='confirmed';
        const canCancel  = o.status!=='canceled';
        const canPend    = o.status!=='pending';
        card.innerHTML = `
          <div class="row">
            <strong>طلب #${String(o.id).slice(0,8)}</strong>
            <div style="display:flex; gap:6px; align-items:center">
              <span class="chip">${o.status}</span>
              <span class="chip" title="${o.created_at}">${new Date(o.created_at).toLocaleString('ar-SA')}</span>
              <button class="btn-ghost" data-copy>نسخ ID</button>
            </div>
          </div>
          <div class="muted" style="margin:.35rem 0">مستخدم: ${o.user_id}</div>
          <div style="display:grid; gap:6px; margin:.35rem 0">
            ${items.map(it=>`<div>${it.product_name} — ${it.qty} × ${SAR.format(it.price)}</div>`).join('')}
          </div>
          <div class="row" style="margin-top:.35rem">
            <div>الخصم: ${SAR.format(o.discount||0)} — <strong>الإجمالي: ${SAR.format(total)}</strong></div>
            <div style="display:flex; gap:8px">
              <button class="btn-ghost" data-refresh>تحديث</button>
              <button class="btn-ghost" data-pending ${canPend?'':'disabled'}>إرجاع Pending</button>
              <button class="btn-ghost danger" data-cancel ${canCancel?'':'disabled'}>إلغاء</button>
              <button class="btn ok" data-confirm ${canConfirm?'':'disabled'}>تأكيد</button>
            </div>
          </div>
        `;
        root.appendChild(card);

        // bind actions
        card.querySelector('[data-refresh]').onclick = load;
        card.querySelector('[data-copy]').onclick    = ()=>{ navigator.clipboard.writeText(o.id); toast('تم نسخ ID'); };
        card.querySelector('[data-confirm]').onclick = ()=> updateStatus(o.id, 'confirmed');
        card.querySelector('[data-cancel]').onclick  = ()=> updateStatus(o.id, 'canceled');
        card.querySelector('[data-pending]').onclick = ()=> updateStatus(o.id, 'pending');
      }
    }

    async function updateStatus(id, status){
      const { error } = await sb.from('orders').update({ status }).eq('id', id);
      if(error){ console.error(error); toast('فشل التحديث'); return; }
      toast('تم التحديث');
      load();
    }

    // ===== Filters / Events =====
    $('#filter-status').addEventListener('change', load);
    $('#search').addEventListener('input', ()=>{ clearTimeout($('#search')._t); $('#search')._t=setTimeout(render,200); });
    $('#btn-refresh').addEventListener('click', load);

    // ===== Export CSV =====
    function toCSV(rows){
      if(!rows.length) return '';
      const cols = Object.keys(rows[0]);
      const esc = v => (v==null?'':String(v).replace(/"/g,'""'));
      const head = cols.join(',');
      const body = rows.map(r=>cols.map(c=>`"${esc(r[c])}"`).join(',')).join('\n');
      return head+'\n'+body;
    }
    function download(name, text){
      const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }
    $('#btn-export-orders').addEventListener('click', async ()=>{
      if(!(await ensureAuth())) return;
      const st = $('#filter-status').value;
      let q = sb.from('orders').select('id,user_id,total,discount,status,created_at').order('created_at',{ascending:false});
      if(st!=='all') q = q.eq('status', st);
      const { data } = await q;
      download('orders.csv', toCSV(data||[]));
    });
    $('#btn-export-items').addEventListener('click', async ()=>{
      if(!(await ensureAuth())) return;
      const ids = (state.orders||[]).map(o=>o.id);
      const { data } = ids.length ? await sb.from('order_items').select('order_id,product_name,price,qty').in('order_id', ids)
                                  : { data: [] };
      download('order_items.csv', toCSV(data||[]));
    });

    // ===== Realtime updates =====
    sb.channel('orders-stream')
      .on('postgres_changes', { event:'*', schema:'public', table:'orders' }, () => load())
      .subscribe();

    // ===== Start =====
    (async ()=>{ if(await ensureAuth()) load(); })();
  </script>
</body>
</html>
